<html>
<head>
<title>reloader.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
reloader.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -</span>
<span class="s0">#</span>
<span class="s0"># This file is part of gunicorn released under the MIT license.</span>
<span class="s0"># See the NOTICE for more information.</span>
<span class="s0"># pylint: disable=no-else-continue</span>

<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">os.path</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">time</span>
<span class="s2">import </span><span class="s1">threading</span>

<span class="s1">COMPILED_EXT_RE = re.compile(</span><span class="s3">r'py[co]$'</span><span class="s1">)</span>


<span class="s2">class </span><span class="s1">Reloader(threading.Thread):</span>
    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">extra_files=</span><span class="s2">None, </span><span class="s1">interval=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">callback=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">super().__init__()</span>
        <span class="s1">self.daemon = </span><span class="s2">True</span>
        <span class="s1">self._extra_files = set(extra_files </span><span class="s2">or </span><span class="s1">())</span>
        <span class="s1">self._interval = interval</span>
        <span class="s1">self._callback = callback</span>

    <span class="s2">def </span><span class="s1">add_extra_file(self</span><span class="s2">, </span><span class="s1">filename):</span>
        <span class="s1">self._extra_files.add(filename)</span>

    <span class="s2">def </span><span class="s1">get_files(self):</span>
        <span class="s1">fnames = [</span>
            <span class="s1">COMPILED_EXT_RE.sub(</span><span class="s3">'py'</span><span class="s2">, </span><span class="s1">module.__file__)</span>
            <span class="s2">for </span><span class="s1">module </span><span class="s2">in </span><span class="s1">tuple(sys.modules.values())</span>
            <span class="s2">if </span><span class="s1">getattr(module</span><span class="s2">, </span><span class="s3">'__file__'</span><span class="s2">, None</span><span class="s1">)</span>
        <span class="s1">]</span>

        <span class="s1">fnames.extend(self._extra_files)</span>

        <span class="s2">return </span><span class="s1">fnames</span>

    <span class="s2">def </span><span class="s1">run(self):</span>
        <span class="s1">mtimes = {}</span>
        <span class="s2">while True</span><span class="s1">:</span>
            <span class="s2">for </span><span class="s1">filename </span><span class="s2">in </span><span class="s1">self.get_files():</span>
                <span class="s2">try</span><span class="s1">:</span>
                    <span class="s1">mtime = os.stat(filename).st_mtime</span>
                <span class="s2">except </span><span class="s1">OSError:</span>
                    <span class="s2">continue</span>
                <span class="s1">old_time = mtimes.get(filename)</span>
                <span class="s2">if </span><span class="s1">old_time </span><span class="s2">is None</span><span class="s1">:</span>
                    <span class="s1">mtimes[filename] = mtime</span>
                    <span class="s2">continue</span>
                <span class="s2">elif </span><span class="s1">mtime &gt; old_time:</span>
                    <span class="s2">if </span><span class="s1">self._callback:</span>
                        <span class="s1">self._callback(filename)</span>
            <span class="s1">time.sleep(self._interval)</span>


<span class="s1">has_inotify = </span><span class="s2">False</span>
<span class="s2">if </span><span class="s1">sys.platform.startswith(</span><span class="s3">'linux'</span><span class="s1">):</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s2">from </span><span class="s1">inotify.adapters </span><span class="s2">import </span><span class="s1">Inotify</span>
        <span class="s2">import </span><span class="s1">inotify.constants</span>
        <span class="s1">has_inotify = </span><span class="s2">True</span>
    <span class="s2">except </span><span class="s1">ImportError:</span>
        <span class="s2">pass</span>


<span class="s2">if </span><span class="s1">has_inotify:</span>

    <span class="s2">class </span><span class="s1">InotifyReloader(threading.Thread):</span>
        <span class="s1">event_mask = (inotify.constants.IN_CREATE | inotify.constants.IN_DELETE</span>
                      <span class="s1">| inotify.constants.IN_DELETE_SELF | inotify.constants.IN_MODIFY</span>
                      <span class="s1">| inotify.constants.IN_MOVE_SELF | inotify.constants.IN_MOVED_FROM</span>
                      <span class="s1">| inotify.constants.IN_MOVED_TO)</span>

        <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">extra_files=</span><span class="s2">None, </span><span class="s1">callback=</span><span class="s2">None</span><span class="s1">):</span>
            <span class="s1">super().__init__()</span>
            <span class="s1">self.daemon = </span><span class="s2">True</span>
            <span class="s1">self._callback = callback</span>
            <span class="s1">self._dirs = set()</span>
            <span class="s1">self._watcher = Inotify()</span>

            <span class="s2">for </span><span class="s1">extra_file </span><span class="s2">in </span><span class="s1">extra_files:</span>
                <span class="s1">self.add_extra_file(extra_file)</span>

        <span class="s2">def </span><span class="s1">add_extra_file(self</span><span class="s2">, </span><span class="s1">filename):</span>
            <span class="s1">dirname = os.path.dirname(filename)</span>

            <span class="s2">if </span><span class="s1">dirname </span><span class="s2">in </span><span class="s1">self._dirs:</span>
                <span class="s2">return</span>

            <span class="s1">self._watcher.add_watch(dirname</span><span class="s2">, </span><span class="s1">mask=self.event_mask)</span>
            <span class="s1">self._dirs.add(dirname)</span>

        <span class="s2">def </span><span class="s1">get_dirs(self):</span>
            <span class="s1">fnames = [</span>
                <span class="s1">os.path.dirname(os.path.abspath(COMPILED_EXT_RE.sub(</span><span class="s3">'py'</span><span class="s2">, </span><span class="s1">module.__file__)))</span>
                <span class="s2">for </span><span class="s1">module </span><span class="s2">in </span><span class="s1">tuple(sys.modules.values())</span>
                <span class="s2">if </span><span class="s1">getattr(module</span><span class="s2">, </span><span class="s3">'__file__'</span><span class="s2">, None</span><span class="s1">)</span>
            <span class="s1">]</span>

            <span class="s2">return </span><span class="s1">set(fnames)</span>

        <span class="s2">def </span><span class="s1">run(self):</span>
            <span class="s1">self._dirs = self.get_dirs()</span>

            <span class="s2">for </span><span class="s1">dirname </span><span class="s2">in </span><span class="s1">self._dirs:</span>
                <span class="s2">if </span><span class="s1">os.path.isdir(dirname):</span>
                    <span class="s1">self._watcher.add_watch(dirname</span><span class="s2">, </span><span class="s1">mask=self.event_mask)</span>

            <span class="s2">for </span><span class="s1">event </span><span class="s2">in </span><span class="s1">self._watcher.event_gen():</span>
                <span class="s2">if </span><span class="s1">event </span><span class="s2">is None</span><span class="s1">:</span>
                    <span class="s2">continue</span>

                <span class="s1">filename = event[</span><span class="s4">3</span><span class="s1">]</span>

                <span class="s1">self._callback(filename)</span>

<span class="s2">else</span><span class="s1">:</span>

    <span class="s2">class </span><span class="s1">InotifyReloader(object):</span>
        <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">extra_files=</span><span class="s2">None, </span><span class="s1">callback=</span><span class="s2">None</span><span class="s1">):</span>
            <span class="s2">raise </span><span class="s1">ImportError(</span><span class="s3">'You must have the inotify module installed to '</span>
                              <span class="s3">'use the inotify reloader'</span><span class="s1">)</span>


<span class="s1">preferred_reloader = InotifyReloader </span><span class="s2">if </span><span class="s1">has_inotify </span><span class="s2">else </span><span class="s1">Reloader</span>

<span class="s1">reloader_engines = {</span>
    <span class="s3">'auto'</span><span class="s1">: preferred_reloader</span><span class="s2">,</span>
    <span class="s3">'poll'</span><span class="s1">: Reloader</span><span class="s2">,</span>
    <span class="s3">'inotify'</span><span class="s1">: InotifyReloader</span><span class="s2">,</span>
<span class="s1">}</span>
</pre>
</body>
</html>