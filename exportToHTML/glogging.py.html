<html>
<head>
<title>glogging.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6897bb;}
.s4 { color: #6a8759;}
.s5 { color: #629755; font-style: italic;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
glogging.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -</span>
<span class="s0">#</span>
<span class="s0"># This file is part of gunicorn released under the MIT license.</span>
<span class="s0"># See the NOTICE for more information.</span>

<span class="s2">import </span><span class="s1">base64</span>
<span class="s2">import </span><span class="s1">binascii</span>
<span class="s2">import </span><span class="s1">json</span>
<span class="s2">import </span><span class="s1">time</span>
<span class="s2">import </span><span class="s1">logging</span>
<span class="s1">logging.Logger.manager.emittedNoHandlerWarning = </span><span class="s3">1  </span><span class="s0"># noqa</span>
<span class="s2">from </span><span class="s1">logging.config </span><span class="s2">import </span><span class="s1">dictConfig</span>
<span class="s2">from </span><span class="s1">logging.config </span><span class="s2">import </span><span class="s1">fileConfig</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">socket</span>
<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">threading</span>
<span class="s2">import </span><span class="s1">traceback</span>

<span class="s2">from </span><span class="s1">gunicorn </span><span class="s2">import </span><span class="s1">util</span>


<span class="s0"># syslog facility codes</span>
<span class="s1">SYSLOG_FACILITIES = {</span>
    <span class="s4">&quot;auth&quot;</span><span class="s1">: </span><span class="s3">4</span><span class="s2">,</span>
    <span class="s4">&quot;authpriv&quot;</span><span class="s1">: </span><span class="s3">10</span><span class="s2">,</span>
    <span class="s4">&quot;cron&quot;</span><span class="s1">: </span><span class="s3">9</span><span class="s2">,</span>
    <span class="s4">&quot;daemon&quot;</span><span class="s1">: </span><span class="s3">3</span><span class="s2">,</span>
    <span class="s4">&quot;ftp&quot;</span><span class="s1">: </span><span class="s3">11</span><span class="s2">,</span>
    <span class="s4">&quot;kern&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s2">,</span>
    <span class="s4">&quot;lpr&quot;</span><span class="s1">: </span><span class="s3">6</span><span class="s2">,</span>
    <span class="s4">&quot;mail&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s2">,</span>
    <span class="s4">&quot;news&quot;</span><span class="s1">: </span><span class="s3">7</span><span class="s2">,</span>
    <span class="s4">&quot;security&quot;</span><span class="s1">: </span><span class="s3">4</span><span class="s2">,  </span><span class="s0"># DEPRECATED</span>
    <span class="s4">&quot;syslog&quot;</span><span class="s1">: </span><span class="s3">5</span><span class="s2">,</span>
    <span class="s4">&quot;user&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s2">,</span>
    <span class="s4">&quot;uucp&quot;</span><span class="s1">: </span><span class="s3">8</span><span class="s2">,</span>
    <span class="s4">&quot;local0&quot;</span><span class="s1">: </span><span class="s3">16</span><span class="s2">,</span>
    <span class="s4">&quot;local1&quot;</span><span class="s1">: </span><span class="s3">17</span><span class="s2">,</span>
    <span class="s4">&quot;local2&quot;</span><span class="s1">: </span><span class="s3">18</span><span class="s2">,</span>
    <span class="s4">&quot;local3&quot;</span><span class="s1">: </span><span class="s3">19</span><span class="s2">,</span>
    <span class="s4">&quot;local4&quot;</span><span class="s1">: </span><span class="s3">20</span><span class="s2">,</span>
    <span class="s4">&quot;local5&quot;</span><span class="s1">: </span><span class="s3">21</span><span class="s2">,</span>
    <span class="s4">&quot;local6&quot;</span><span class="s1">: </span><span class="s3">22</span><span class="s2">,</span>
    <span class="s4">&quot;local7&quot;</span><span class="s1">: </span><span class="s3">23</span>
<span class="s1">}</span>

<span class="s1">CONFIG_DEFAULTS = {</span>
    <span class="s4">&quot;version&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s2">,</span>
    <span class="s4">&quot;disable_existing_loggers&quot;</span><span class="s1">: </span><span class="s2">False,</span>
    <span class="s4">&quot;root&quot;</span><span class="s1">: {</span><span class="s4">&quot;level&quot;</span><span class="s1">: </span><span class="s4">&quot;INFO&quot;</span><span class="s2">, </span><span class="s4">&quot;handlers&quot;</span><span class="s1">: [</span><span class="s4">&quot;console&quot;</span><span class="s1">]}</span><span class="s2">,</span>
    <span class="s4">&quot;loggers&quot;</span><span class="s1">: {</span>
        <span class="s4">&quot;gunicorn.error&quot;</span><span class="s1">: {</span>
            <span class="s4">&quot;level&quot;</span><span class="s1">: </span><span class="s4">&quot;INFO&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;handlers&quot;</span><span class="s1">: [</span><span class="s4">&quot;error_console&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;propagate&quot;</span><span class="s1">: </span><span class="s2">True,</span>
            <span class="s4">&quot;qualname&quot;</span><span class="s1">: </span><span class="s4">&quot;gunicorn.error&quot;</span>
        <span class="s1">}</span><span class="s2">,</span>

        <span class="s4">&quot;gunicorn.access&quot;</span><span class="s1">: {</span>
            <span class="s4">&quot;level&quot;</span><span class="s1">: </span><span class="s4">&quot;INFO&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;handlers&quot;</span><span class="s1">: [</span><span class="s4">&quot;console&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;propagate&quot;</span><span class="s1">: </span><span class="s2">True,</span>
            <span class="s4">&quot;qualname&quot;</span><span class="s1">: </span><span class="s4">&quot;gunicorn.access&quot;</span>
        <span class="s1">}</span>
    <span class="s1">}</span><span class="s2">,</span>
    <span class="s4">&quot;handlers&quot;</span><span class="s1">: {</span>
        <span class="s4">&quot;console&quot;</span><span class="s1">: {</span>
            <span class="s4">&quot;class&quot;</span><span class="s1">: </span><span class="s4">&quot;logging.StreamHandler&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;formatter&quot;</span><span class="s1">: </span><span class="s4">&quot;generic&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;stream&quot;</span><span class="s1">: </span><span class="s4">&quot;ext://sys.stdout&quot;</span>
        <span class="s1">}</span><span class="s2">,</span>
        <span class="s4">&quot;error_console&quot;</span><span class="s1">: {</span>
            <span class="s4">&quot;class&quot;</span><span class="s1">: </span><span class="s4">&quot;logging.StreamHandler&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;formatter&quot;</span><span class="s1">: </span><span class="s4">&quot;generic&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;stream&quot;</span><span class="s1">: </span><span class="s4">&quot;ext://sys.stderr&quot;</span>
        <span class="s1">}</span><span class="s2">,</span>
    <span class="s1">}</span><span class="s2">,</span>
    <span class="s4">&quot;formatters&quot;</span><span class="s1">: {</span>
        <span class="s4">&quot;generic&quot;</span><span class="s1">: {</span>
            <span class="s4">&quot;format&quot;</span><span class="s1">: </span><span class="s4">&quot;%(asctime)s [%(process)d] [%(levelname)s] %(message)s&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;datefmt&quot;</span><span class="s1">: </span><span class="s4">&quot;[%Y-%m-%d %H:%M:%S %z]&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;class&quot;</span><span class="s1">: </span><span class="s4">&quot;logging.Formatter&quot;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
<span class="s1">}</span>


<span class="s2">def </span><span class="s1">loggers():</span>
    <span class="s5">&quot;&quot;&quot; get list of all loggers &quot;&quot;&quot;</span>
    <span class="s1">root = logging.root</span>
    <span class="s1">existing = list(root.manager.loggerDict.keys())</span>
    <span class="s2">return </span><span class="s1">[logging.getLogger(name) </span><span class="s2">for </span><span class="s1">name </span><span class="s2">in </span><span class="s1">existing]</span>


<span class="s2">class </span><span class="s1">SafeAtoms(dict):</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">atoms):</span>
        <span class="s1">dict.__init__(self)</span>
        <span class="s2">for </span><span class="s1">key</span><span class="s2">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">atoms.items():</span>
            <span class="s2">if </span><span class="s1">isinstance(value</span><span class="s2">, </span><span class="s1">str):</span>
                <span class="s1">self[key] = value.replace(</span><span class="s4">'&quot;'</span><span class="s2">, </span><span class="s4">'</span><span class="s2">\\</span><span class="s4">&quot;'</span><span class="s1">)</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">self[key] = value</span>

    <span class="s2">def </span><span class="s1">__getitem__(self</span><span class="s2">, </span><span class="s1">k):</span>
        <span class="s2">if </span><span class="s1">k.startswith(</span><span class="s4">&quot;{&quot;</span><span class="s1">):</span>
            <span class="s1">kl = k.lower()</span>
            <span class="s2">if </span><span class="s1">kl </span><span class="s2">in </span><span class="s1">self:</span>
                <span class="s2">return </span><span class="s1">super().__getitem__(kl)</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s2">return </span><span class="s4">&quot;-&quot;</span>
        <span class="s2">if </span><span class="s1">k </span><span class="s2">in </span><span class="s1">self:</span>
            <span class="s2">return </span><span class="s1">super().__getitem__(k)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s4">'-'</span>


<span class="s2">def </span><span class="s1">parse_syslog_address(addr):</span>

    <span class="s0"># unix domain socket type depends on backend</span>
    <span class="s0"># SysLogHandler will try both when given None</span>
    <span class="s2">if </span><span class="s1">addr.startswith(</span><span class="s4">&quot;unix://&quot;</span><span class="s1">):</span>
        <span class="s1">sock_type = </span><span class="s2">None</span>

        <span class="s0"># set socket type only if explicitly requested</span>
        <span class="s1">parts = addr.split(</span><span class="s4">&quot;#&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">len(parts) == </span><span class="s3">2</span><span class="s1">:</span>
            <span class="s1">addr = parts[</span><span class="s3">0</span><span class="s1">]</span>
            <span class="s2">if </span><span class="s1">parts[</span><span class="s3">1</span><span class="s1">] == </span><span class="s4">&quot;dgram&quot;</span><span class="s1">:</span>
                <span class="s1">sock_type = socket.SOCK_DGRAM</span>

        <span class="s2">return </span><span class="s1">(sock_type</span><span class="s2">, </span><span class="s1">addr.split(</span><span class="s4">&quot;unix://&quot;</span><span class="s1">)[</span><span class="s3">1</span><span class="s1">])</span>

    <span class="s2">if </span><span class="s1">addr.startswith(</span><span class="s4">&quot;udp://&quot;</span><span class="s1">):</span>
        <span class="s1">addr = addr.split(</span><span class="s4">&quot;udp://&quot;</span><span class="s1">)[</span><span class="s3">1</span><span class="s1">]</span>
        <span class="s1">socktype = socket.SOCK_DGRAM</span>
    <span class="s2">elif </span><span class="s1">addr.startswith(</span><span class="s4">&quot;tcp://&quot;</span><span class="s1">):</span>
        <span class="s1">addr = addr.split(</span><span class="s4">&quot;tcp://&quot;</span><span class="s1">)[</span><span class="s3">1</span><span class="s1">]</span>
        <span class="s1">socktype = socket.SOCK_STREAM</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">raise </span><span class="s1">RuntimeError(</span><span class="s4">&quot;invalid syslog address&quot;</span><span class="s1">)</span>

    <span class="s2">if </span><span class="s4">'[' </span><span class="s2">in </span><span class="s1">addr </span><span class="s2">and </span><span class="s4">']' </span><span class="s2">in </span><span class="s1">addr:</span>
        <span class="s1">host = addr.split(</span><span class="s4">']'</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">][</span><span class="s3">1</span><span class="s1">:].lower()</span>
    <span class="s2">elif </span><span class="s4">':' </span><span class="s2">in </span><span class="s1">addr:</span>
        <span class="s1">host = addr.split(</span><span class="s4">':'</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">].lower()</span>
    <span class="s2">elif </span><span class="s1">addr == </span><span class="s4">&quot;&quot;</span><span class="s1">:</span>
        <span class="s1">host = </span><span class="s4">&quot;localhost&quot;</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">host = addr.lower()</span>

    <span class="s1">addr = addr.split(</span><span class="s4">']'</span><span class="s1">)[-</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s2">if </span><span class="s4">&quot;:&quot; </span><span class="s2">in </span><span class="s1">addr:</span>
        <span class="s1">port = addr.split(</span><span class="s4">':'</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)[</span><span class="s3">1</span><span class="s1">]</span>
        <span class="s2">if not </span><span class="s1">port.isdigit():</span>
            <span class="s2">raise </span><span class="s1">RuntimeError(</span><span class="s4">&quot;%r is not a valid port number.&quot; </span><span class="s1">% port)</span>
        <span class="s1">port = int(port)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">port = </span><span class="s3">514</span>

    <span class="s2">return </span><span class="s1">(socktype</span><span class="s2">, </span><span class="s1">(host</span><span class="s2">, </span><span class="s1">port))</span>


<span class="s2">class </span><span class="s1">Logger(object):</span>

    <span class="s1">LOG_LEVELS = {</span>
        <span class="s4">&quot;critical&quot;</span><span class="s1">: logging.CRITICAL</span><span class="s2">,</span>
        <span class="s4">&quot;error&quot;</span><span class="s1">: logging.ERROR</span><span class="s2">,</span>
        <span class="s4">&quot;warning&quot;</span><span class="s1">: logging.WARNING</span><span class="s2">,</span>
        <span class="s4">&quot;info&quot;</span><span class="s1">: logging.INFO</span><span class="s2">,</span>
        <span class="s4">&quot;debug&quot;</span><span class="s1">: logging.DEBUG</span>
    <span class="s1">}</span>
    <span class="s1">loglevel = logging.INFO</span>

    <span class="s1">error_fmt = </span><span class="s4">r&quot;%(asctime)s [%(process)d] [%(levelname)s] %(message)s&quot;</span>
    <span class="s1">datefmt = </span><span class="s4">r&quot;[%Y-%m-%d %H:%M:%S %z]&quot;</span>

    <span class="s1">access_fmt = </span><span class="s4">&quot;%(message)s&quot;</span>
    <span class="s1">syslog_fmt = </span><span class="s4">&quot;[%(process)d] %(message)s&quot;</span>

    <span class="s1">atoms_wrapper_class = SafeAtoms</span>

    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">cfg):</span>
        <span class="s1">self.error_log = logging.getLogger(</span><span class="s4">&quot;gunicorn.error&quot;</span><span class="s1">)</span>
        <span class="s1">self.error_log.propagate = </span><span class="s2">False</span>
        <span class="s1">self.access_log = logging.getLogger(</span><span class="s4">&quot;gunicorn.access&quot;</span><span class="s1">)</span>
        <span class="s1">self.access_log.propagate = </span><span class="s2">False</span>
        <span class="s1">self.error_handlers = []</span>
        <span class="s1">self.access_handlers = []</span>
        <span class="s1">self.logfile = </span><span class="s2">None</span>
        <span class="s1">self.lock = threading.Lock()</span>
        <span class="s1">self.cfg = cfg</span>
        <span class="s1">self.setup(cfg)</span>

    <span class="s2">def </span><span class="s1">setup(self</span><span class="s2">, </span><span class="s1">cfg):</span>
        <span class="s1">self.loglevel = self.LOG_LEVELS.get(cfg.loglevel.lower()</span><span class="s2">, </span><span class="s1">logging.INFO)</span>
        <span class="s1">self.error_log.setLevel(self.loglevel)</span>
        <span class="s1">self.access_log.setLevel(logging.INFO)</span>

        <span class="s0"># set gunicorn.error handler</span>
        <span class="s2">if </span><span class="s1">self.cfg.capture_output </span><span class="s2">and </span><span class="s1">cfg.errorlog != </span><span class="s4">&quot;-&quot;</span><span class="s1">:</span>
            <span class="s2">for </span><span class="s1">stream </span><span class="s2">in </span><span class="s1">sys.stdout</span><span class="s2">, </span><span class="s1">sys.stderr:</span>
                <span class="s1">stream.flush()</span>

            <span class="s1">self.logfile = open(cfg.errorlog</span><span class="s2">, </span><span class="s4">'a+'</span><span class="s1">)</span>
            <span class="s1">os.dup2(self.logfile.fileno()</span><span class="s2">, </span><span class="s1">sys.stdout.fileno())</span>
            <span class="s1">os.dup2(self.logfile.fileno()</span><span class="s2">, </span><span class="s1">sys.stderr.fileno())</span>

        <span class="s1">self._set_handler(self.error_log</span><span class="s2">, </span><span class="s1">cfg.errorlog</span><span class="s2">,</span>
                          <span class="s1">logging.Formatter(self.error_fmt</span><span class="s2">, </span><span class="s1">self.datefmt))</span>

        <span class="s0"># set gunicorn.access handler</span>
        <span class="s2">if </span><span class="s1">cfg.accesslog </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s1">self._set_handler(</span>
                <span class="s1">self.access_log</span><span class="s2">, </span><span class="s1">cfg.accesslog</span><span class="s2">,</span>
                <span class="s1">fmt=logging.Formatter(self.access_fmt)</span><span class="s2">, </span><span class="s1">stream=sys.stdout</span>
            <span class="s1">)</span>

        <span class="s0"># set syslog handler</span>
        <span class="s2">if </span><span class="s1">cfg.syslog:</span>
            <span class="s1">self._set_syslog_handler(</span>
                <span class="s1">self.error_log</span><span class="s2">, </span><span class="s1">cfg</span><span class="s2">, </span><span class="s1">self.syslog_fmt</span><span class="s2">, </span><span class="s4">&quot;error&quot;</span>
            <span class="s1">)</span>
            <span class="s2">if not </span><span class="s1">cfg.disable_redirect_access_to_syslog:</span>
                <span class="s1">self._set_syslog_handler(</span>
                    <span class="s1">self.access_log</span><span class="s2">, </span><span class="s1">cfg</span><span class="s2">, </span><span class="s1">self.syslog_fmt</span><span class="s2">, </span><span class="s4">&quot;access&quot;</span>
                <span class="s1">)</span>

        <span class="s2">if </span><span class="s1">cfg.logconfig_dict:</span>
            <span class="s1">config = CONFIG_DEFAULTS.copy()</span>
            <span class="s1">config.update(cfg.logconfig_dict)</span>
            <span class="s2">try</span><span class="s1">:</span>
                <span class="s1">dictConfig(config)</span>
            <span class="s2">except </span><span class="s1">(</span>
                    <span class="s1">AttributeError</span><span class="s2">,</span>
                    <span class="s1">ImportError</span><span class="s2">,</span>
                    <span class="s1">ValueError</span><span class="s2">,</span>
                    <span class="s1">TypeError</span>
            <span class="s1">) </span><span class="s2">as </span><span class="s1">exc:</span>
                <span class="s2">raise </span><span class="s1">RuntimeError(str(exc))</span>
        <span class="s2">elif </span><span class="s1">cfg.logconfig_json:</span>
            <span class="s1">config = CONFIG_DEFAULTS.copy()</span>
            <span class="s2">if </span><span class="s1">os.path.exists(cfg.logconfig_json):</span>
                <span class="s2">try</span><span class="s1">:</span>
                    <span class="s1">config_json = json.load(open(cfg.logconfig_json))</span>
                    <span class="s1">config.update(config_json)</span>
                    <span class="s1">dictConfig(config)</span>
                <span class="s2">except </span><span class="s1">(</span>
                    <span class="s1">json.JSONDecodeError</span><span class="s2">,</span>
                    <span class="s1">AttributeError</span><span class="s2">,</span>
                    <span class="s1">ImportError</span><span class="s2">,</span>
                    <span class="s1">ValueError</span><span class="s2">,</span>
                    <span class="s1">TypeError</span>
                <span class="s1">) </span><span class="s2">as </span><span class="s1">exc:</span>
                    <span class="s2">raise </span><span class="s1">RuntimeError(str(exc))</span>
        <span class="s2">elif </span><span class="s1">cfg.logconfig:</span>
            <span class="s2">if </span><span class="s1">os.path.exists(cfg.logconfig):</span>
                <span class="s1">defaults = CONFIG_DEFAULTS.copy()</span>
                <span class="s1">defaults[</span><span class="s4">'__file__'</span><span class="s1">] = cfg.logconfig</span>
                <span class="s1">defaults[</span><span class="s4">'here'</span><span class="s1">] = os.path.dirname(cfg.logconfig)</span>
                <span class="s1">fileConfig(cfg.logconfig</span><span class="s2">, </span><span class="s1">defaults=defaults</span><span class="s2">,</span>
                           <span class="s1">disable_existing_loggers=</span><span class="s2">False</span><span class="s1">)</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">msg = </span><span class="s4">&quot;Error: log config '%s' not found&quot;</span>
                <span class="s2">raise </span><span class="s1">RuntimeError(msg % cfg.logconfig)</span>

    <span class="s2">def </span><span class="s1">critical(self</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
        <span class="s1">self.error_log.critical(msg</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs)</span>

    <span class="s2">def </span><span class="s1">error(self</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
        <span class="s1">self.error_log.error(msg</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs)</span>

    <span class="s2">def </span><span class="s1">warning(self</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
        <span class="s1">self.error_log.warning(msg</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs)</span>

    <span class="s2">def </span><span class="s1">info(self</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
        <span class="s1">self.error_log.info(msg</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs)</span>

    <span class="s2">def </span><span class="s1">debug(self</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
        <span class="s1">self.error_log.debug(msg</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs)</span>

    <span class="s2">def </span><span class="s1">exception(self</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
        <span class="s1">self.error_log.exception(msg</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs)</span>

    <span class="s2">def </span><span class="s1">log(self</span><span class="s2">, </span><span class="s1">lvl</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
        <span class="s2">if </span><span class="s1">isinstance(lvl</span><span class="s2">, </span><span class="s1">str):</span>
            <span class="s1">lvl = self.LOG_LEVELS.get(lvl.lower()</span><span class="s2">, </span><span class="s1">logging.INFO)</span>
        <span class="s1">self.error_log.log(lvl</span><span class="s2">, </span><span class="s1">msg</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs)</span>

    <span class="s2">def </span><span class="s1">atoms(self</span><span class="s2">, </span><span class="s1">resp</span><span class="s2">, </span><span class="s1">req</span><span class="s2">, </span><span class="s1">environ</span><span class="s2">, </span><span class="s1">request_time):</span>
        <span class="s5">&quot;&quot;&quot; Gets atoms for log formatting. 
        &quot;&quot;&quot;</span>
        <span class="s1">status = resp.status</span>
        <span class="s2">if </span><span class="s1">isinstance(status</span><span class="s2">, </span><span class="s1">str):</span>
            <span class="s1">status = status.split(</span><span class="s2">None, </span><span class="s3">1</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">atoms = {</span>
            <span class="s4">'h'</span><span class="s1">: environ.get(</span><span class="s4">'REMOTE_ADDR'</span><span class="s2">, </span><span class="s4">'-'</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">'l'</span><span class="s1">: </span><span class="s4">'-'</span><span class="s2">,</span>
            <span class="s4">'u'</span><span class="s1">: self._get_user(environ) </span><span class="s2">or </span><span class="s4">'-'</span><span class="s2">,</span>
            <span class="s4">'t'</span><span class="s1">: self.now()</span><span class="s2">,</span>
            <span class="s4">'r'</span><span class="s1">: </span><span class="s4">&quot;%s %s %s&quot; </span><span class="s1">% (environ[</span><span class="s4">'REQUEST_METHOD'</span><span class="s1">]</span><span class="s2">,</span>
                               <span class="s1">environ[</span><span class="s4">'RAW_URI'</span><span class="s1">]</span><span class="s2">,</span>
                               <span class="s1">environ[</span><span class="s4">&quot;SERVER_PROTOCOL&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s4">'s'</span><span class="s1">: status</span><span class="s2">,</span>
            <span class="s4">'m'</span><span class="s1">: environ.get(</span><span class="s4">'REQUEST_METHOD'</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">'U'</span><span class="s1">: environ.get(</span><span class="s4">'PATH_INFO'</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">'q'</span><span class="s1">: environ.get(</span><span class="s4">'QUERY_STRING'</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">'H'</span><span class="s1">: environ.get(</span><span class="s4">'SERVER_PROTOCOL'</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">'b'</span><span class="s1">: getattr(resp</span><span class="s2">, </span><span class="s4">'sent'</span><span class="s2">, None</span><span class="s1">) </span><span class="s2">is not None and </span><span class="s1">str(resp.sent) </span><span class="s2">or </span><span class="s4">'-'</span><span class="s2">,</span>
            <span class="s4">'B'</span><span class="s1">: getattr(resp</span><span class="s2">, </span><span class="s4">'sent'</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">'f'</span><span class="s1">: environ.get(</span><span class="s4">'HTTP_REFERER'</span><span class="s2">, </span><span class="s4">'-'</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">'a'</span><span class="s1">: environ.get(</span><span class="s4">'HTTP_USER_AGENT'</span><span class="s2">, </span><span class="s4">'-'</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">'T'</span><span class="s1">: request_time.seconds</span><span class="s2">,</span>
            <span class="s4">'D'</span><span class="s1">: (request_time.seconds * </span><span class="s3">1000000</span><span class="s1">) + request_time.microseconds</span><span class="s2">,</span>
            <span class="s4">'M'</span><span class="s1">: (request_time.seconds * </span><span class="s3">1000</span><span class="s1">) + int(request_time.microseconds / </span><span class="s3">1000</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">'L'</span><span class="s1">: </span><span class="s4">&quot;%d.%06d&quot; </span><span class="s1">% (request_time.seconds</span><span class="s2">, </span><span class="s1">request_time.microseconds)</span><span class="s2">,</span>
            <span class="s4">'p'</span><span class="s1">: </span><span class="s4">&quot;&lt;%s&gt;&quot; </span><span class="s1">% os.getpid()</span>
        <span class="s1">}</span>

        <span class="s0"># add request headers</span>
        <span class="s2">if </span><span class="s1">hasattr(req</span><span class="s2">, </span><span class="s4">'headers'</span><span class="s1">):</span>
            <span class="s1">req_headers = req.headers</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">req_headers = req</span>

        <span class="s2">if </span><span class="s1">hasattr(req_headers</span><span class="s2">, </span><span class="s4">&quot;items&quot;</span><span class="s1">):</span>
            <span class="s1">req_headers = req_headers.items()</span>

        <span class="s1">atoms.update({</span><span class="s4">&quot;{%s}i&quot; </span><span class="s1">% k.lower(): v </span><span class="s2">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">req_headers})</span>

        <span class="s1">resp_headers = resp.headers</span>
        <span class="s2">if </span><span class="s1">hasattr(resp_headers</span><span class="s2">, </span><span class="s4">&quot;items&quot;</span><span class="s1">):</span>
            <span class="s1">resp_headers = resp_headers.items()</span>

        <span class="s0"># add response headers</span>
        <span class="s1">atoms.update({</span><span class="s4">&quot;{%s}o&quot; </span><span class="s1">% k.lower(): v </span><span class="s2">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">resp_headers})</span>

        <span class="s0"># add environ variables</span>
        <span class="s1">environ_variables = environ.items()</span>
        <span class="s1">atoms.update({</span><span class="s4">&quot;{%s}e&quot; </span><span class="s1">% k.lower(): v </span><span class="s2">for </span><span class="s1">k</span><span class="s2">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">environ_variables})</span>

        <span class="s2">return </span><span class="s1">atoms</span>

    <span class="s2">def </span><span class="s1">access(self</span><span class="s2">, </span><span class="s1">resp</span><span class="s2">, </span><span class="s1">req</span><span class="s2">, </span><span class="s1">environ</span><span class="s2">, </span><span class="s1">request_time):</span>
        <span class="s5">&quot;&quot;&quot; See http://httpd.apache.org/docs/2.0/logs.html#combined 
        for format details 
        &quot;&quot;&quot;</span>

        <span class="s2">if not </span><span class="s1">(self.cfg.accesslog </span><span class="s2">or </span><span class="s1">self.cfg.logconfig </span><span class="s2">or</span>
           <span class="s1">self.cfg.logconfig_dict </span><span class="s2">or </span><span class="s1">self.cfg.logconfig_json </span><span class="s2">or</span>
           <span class="s1">(self.cfg.syslog </span><span class="s2">and not </span><span class="s1">self.cfg.disable_redirect_access_to_syslog)):</span>
            <span class="s2">return</span>

        <span class="s0"># wrap atoms:</span>
        <span class="s0"># - make sure atoms will be test case insensitively</span>
        <span class="s0"># - if atom doesn't exist replace it by '-'</span>
        <span class="s1">safe_atoms = self.atoms_wrapper_class(</span>
            <span class="s1">self.atoms(resp</span><span class="s2">, </span><span class="s1">req</span><span class="s2">, </span><span class="s1">environ</span><span class="s2">, </span><span class="s1">request_time)</span>
        <span class="s1">)</span>

        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">self.access_log.info(self.cfg.access_log_format</span><span class="s2">, </span><span class="s1">safe_atoms)</span>
        <span class="s2">except </span><span class="s1">Exception:</span>
            <span class="s1">self.error(traceback.format_exc())</span>

    <span class="s2">def </span><span class="s1">now(self):</span>
        <span class="s5">&quot;&quot;&quot; return date in Apache Common Log Format &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">time.strftime(</span><span class="s4">'[%d/%b/%Y:%H:%M:%S %z]'</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">reopen_files(self):</span>
        <span class="s2">if </span><span class="s1">self.cfg.capture_output </span><span class="s2">and </span><span class="s1">self.cfg.errorlog != </span><span class="s4">&quot;-&quot;</span><span class="s1">:</span>
            <span class="s2">for </span><span class="s1">stream </span><span class="s2">in </span><span class="s1">sys.stdout</span><span class="s2">, </span><span class="s1">sys.stderr:</span>
                <span class="s1">stream.flush()</span>

            <span class="s2">with </span><span class="s1">self.lock:</span>
                <span class="s2">if </span><span class="s1">self.logfile </span><span class="s2">is not None</span><span class="s1">:</span>
                    <span class="s1">self.logfile.close()</span>
                <span class="s1">self.logfile = open(self.cfg.errorlog</span><span class="s2">, </span><span class="s4">'a+'</span><span class="s1">)</span>
                <span class="s1">os.dup2(self.logfile.fileno()</span><span class="s2">, </span><span class="s1">sys.stdout.fileno())</span>
                <span class="s1">os.dup2(self.logfile.fileno()</span><span class="s2">, </span><span class="s1">sys.stderr.fileno())</span>

        <span class="s2">for </span><span class="s1">log </span><span class="s2">in </span><span class="s1">loggers():</span>
            <span class="s2">for </span><span class="s1">handler </span><span class="s2">in </span><span class="s1">log.handlers:</span>
                <span class="s2">if </span><span class="s1">isinstance(handler</span><span class="s2">, </span><span class="s1">logging.FileHandler):</span>
                    <span class="s1">handler.acquire()</span>
                    <span class="s2">try</span><span class="s1">:</span>
                        <span class="s2">if </span><span class="s1">handler.stream:</span>
                            <span class="s1">handler.close()</span>
                            <span class="s1">handler.stream = handler._open()</span>
                    <span class="s2">finally</span><span class="s1">:</span>
                        <span class="s1">handler.release()</span>

    <span class="s2">def </span><span class="s1">close_on_exec(self):</span>
        <span class="s2">for </span><span class="s1">log </span><span class="s2">in </span><span class="s1">loggers():</span>
            <span class="s2">for </span><span class="s1">handler </span><span class="s2">in </span><span class="s1">log.handlers:</span>
                <span class="s2">if </span><span class="s1">isinstance(handler</span><span class="s2">, </span><span class="s1">logging.FileHandler):</span>
                    <span class="s1">handler.acquire()</span>
                    <span class="s2">try</span><span class="s1">:</span>
                        <span class="s2">if </span><span class="s1">handler.stream:</span>
                            <span class="s1">util.close_on_exec(handler.stream.fileno())</span>
                    <span class="s2">finally</span><span class="s1">:</span>
                        <span class="s1">handler.release()</span>

    <span class="s2">def </span><span class="s1">_get_gunicorn_handler(self</span><span class="s2">, </span><span class="s1">log):</span>
        <span class="s2">for </span><span class="s1">h </span><span class="s2">in </span><span class="s1">log.handlers:</span>
            <span class="s2">if </span><span class="s1">getattr(h</span><span class="s2">, </span><span class="s4">&quot;_gunicorn&quot;</span><span class="s2">, False</span><span class="s1">):</span>
                <span class="s2">return </span><span class="s1">h</span>

    <span class="s2">def </span><span class="s1">_set_handler(self</span><span class="s2">, </span><span class="s1">log</span><span class="s2">, </span><span class="s1">output</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">stream=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s0"># remove previous gunicorn log handler</span>
        <span class="s1">h = self._get_gunicorn_handler(log)</span>
        <span class="s2">if </span><span class="s1">h:</span>
            <span class="s1">log.handlers.remove(h)</span>

        <span class="s2">if </span><span class="s1">output </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s2">if </span><span class="s1">output == </span><span class="s4">&quot;-&quot;</span><span class="s1">:</span>
                <span class="s1">h = logging.StreamHandler(stream)</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">util.check_is_writable(output)</span>
                <span class="s1">h = logging.FileHandler(output)</span>
                <span class="s0"># make sure the user can reopen the file</span>
                <span class="s2">try</span><span class="s1">:</span>
                    <span class="s1">os.chown(h.baseFilename</span><span class="s2">, </span><span class="s1">self.cfg.user</span><span class="s2">, </span><span class="s1">self.cfg.group)</span>
                <span class="s2">except </span><span class="s1">OSError:</span>
                    <span class="s0"># it's probably OK there, we assume the user has given</span>
                    <span class="s0"># /dev/null as a parameter.</span>
                    <span class="s2">pass</span>

            <span class="s1">h.setFormatter(fmt)</span>
            <span class="s1">h._gunicorn = </span><span class="s2">True</span>
            <span class="s1">log.addHandler(h)</span>

    <span class="s2">def </span><span class="s1">_set_syslog_handler(self</span><span class="s2">, </span><span class="s1">log</span><span class="s2">, </span><span class="s1">cfg</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">, </span><span class="s1">name):</span>
        <span class="s0"># setup format</span>
        <span class="s1">prefix = cfg.syslog_prefix </span><span class="s2">or </span><span class="s1">cfg.proc_name.replace(</span><span class="s4">&quot;:&quot;</span><span class="s2">, </span><span class="s4">&quot;.&quot;</span><span class="s1">)</span>

        <span class="s1">prefix = </span><span class="s4">&quot;gunicorn.%s.%s&quot; </span><span class="s1">% (prefix</span><span class="s2">, </span><span class="s1">name)</span>

        <span class="s0"># set format</span>
        <span class="s1">fmt = logging.Formatter(</span><span class="s4">r&quot;%s: %s&quot; </span><span class="s1">% (prefix</span><span class="s2">, </span><span class="s1">fmt))</span>

        <span class="s0"># syslog facility</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">facility = SYSLOG_FACILITIES[cfg.syslog_facility.lower()]</span>
        <span class="s2">except </span><span class="s1">KeyError:</span>
            <span class="s2">raise </span><span class="s1">RuntimeError(</span><span class="s4">&quot;unknown facility name&quot;</span><span class="s1">)</span>

        <span class="s0"># parse syslog address</span>
        <span class="s1">socktype</span><span class="s2">, </span><span class="s1">addr = parse_syslog_address(cfg.syslog_addr)</span>

        <span class="s0"># finally setup the syslog handler</span>
        <span class="s1">h = logging.handlers.SysLogHandler(address=addr</span><span class="s2">,</span>
                                           <span class="s1">facility=facility</span><span class="s2">, </span><span class="s1">socktype=socktype)</span>

        <span class="s1">h.setFormatter(fmt)</span>
        <span class="s1">h._gunicorn = </span><span class="s2">True</span>
        <span class="s1">log.addHandler(h)</span>

    <span class="s2">def </span><span class="s1">_get_user(self</span><span class="s2">, </span><span class="s1">environ):</span>
        <span class="s1">user = </span><span class="s2">None</span>
        <span class="s1">http_auth = environ.get(</span><span class="s4">&quot;HTTP_AUTHORIZATION&quot;</span><span class="s1">)</span>
        <span class="s2">if </span><span class="s1">http_auth </span><span class="s2">and </span><span class="s1">http_auth.lower().startswith(</span><span class="s4">'basic'</span><span class="s1">):</span>
            <span class="s1">auth = http_auth.split(</span><span class="s4">&quot; &quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)</span>
            <span class="s2">if </span><span class="s1">len(auth) == </span><span class="s3">2</span><span class="s1">:</span>
                <span class="s2">try</span><span class="s1">:</span>
                    <span class="s0"># b64decode doesn't accept unicode in Python &lt; 3.3</span>
                    <span class="s0"># so we need to convert it to a byte string</span>
                    <span class="s1">auth = base64.b64decode(auth[</span><span class="s3">1</span><span class="s1">].strip().encode(</span><span class="s4">'utf-8'</span><span class="s1">))</span>
                    <span class="s0"># b64decode returns a byte string</span>
                    <span class="s1">user = auth.split(</span><span class="s6">b&quot;:&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">].decode(</span><span class="s4">&quot;UTF-8&quot;</span><span class="s1">)</span>
                <span class="s2">except </span><span class="s1">(TypeError</span><span class="s2">, </span><span class="s1">binascii.Error</span><span class="s2">, </span><span class="s1">UnicodeDecodeError) </span><span class="s2">as </span><span class="s1">exc:</span>
                    <span class="s1">self.debug(</span><span class="s4">&quot;Couldn't get username: %s&quot;</span><span class="s2">, </span><span class="s1">exc)</span>
        <span class="s2">return </span><span class="s1">user</span>
</pre>
</body>
</html>