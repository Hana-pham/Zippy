<html>
<head>
<title>connection.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
connection.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">typing</span>

<span class="s2"># use http.client.HTTPException for consistency with non-emscripten</span>
<span class="s0">from </span><span class="s1">http.client </span><span class="s0">import </span><span class="s1">HTTPException </span><span class="s0">as </span><span class="s1">HTTPException  </span><span class="s2"># noqa: F401</span>
<span class="s0">from </span><span class="s1">http.client </span><span class="s0">import </span><span class="s1">ResponseNotReady</span>

<span class="s0">from </span><span class="s1">..._base_connection </span><span class="s0">import </span><span class="s1">_TYPE_BODY</span>
<span class="s0">from </span><span class="s1">...connection </span><span class="s0">import </span><span class="s1">HTTPConnection</span><span class="s0">, </span><span class="s1">ProxyConfig</span><span class="s0">, </span><span class="s1">port_by_scheme</span>
<span class="s0">from </span><span class="s1">...exceptions </span><span class="s0">import </span><span class="s1">TimeoutError</span>
<span class="s0">from </span><span class="s1">...response </span><span class="s0">import </span><span class="s1">BaseHTTPResponse</span>
<span class="s0">from </span><span class="s1">...util.connection </span><span class="s0">import </span><span class="s1">_TYPE_SOCKET_OPTIONS</span>
<span class="s0">from </span><span class="s1">...util.timeout </span><span class="s0">import </span><span class="s1">_DEFAULT_TIMEOUT</span><span class="s0">, </span><span class="s1">_TYPE_TIMEOUT</span>
<span class="s0">from </span><span class="s1">...util.url </span><span class="s0">import </span><span class="s1">Url</span>
<span class="s0">from </span><span class="s1">.fetch </span><span class="s0">import </span><span class="s1">_RequestError</span><span class="s0">, </span><span class="s1">_TimeoutError</span><span class="s0">, </span><span class="s1">send_request</span><span class="s0">, </span><span class="s1">send_streaming_request</span>
<span class="s0">from </span><span class="s1">.request </span><span class="s0">import </span><span class="s1">EmscriptenRequest</span>
<span class="s0">from </span><span class="s1">.response </span><span class="s0">import </span><span class="s1">EmscriptenHttpResponseWrapper</span><span class="s0">, </span><span class="s1">EmscriptenResponse</span>

<span class="s0">if </span><span class="s1">typing.TYPE_CHECKING:</span>
    <span class="s0">from </span><span class="s1">..._base_connection </span><span class="s0">import </span><span class="s1">BaseHTTPConnection</span><span class="s0">, </span><span class="s1">BaseHTTPSConnection</span>


<span class="s0">class </span><span class="s1">EmscriptenHTTPConnection:</span>
    <span class="s1">default_port: typing.ClassVar[int] = port_by_scheme[</span><span class="s3">&quot;http&quot;</span><span class="s1">]</span>
    <span class="s1">default_socket_options: typing.ClassVar[_TYPE_SOCKET_OPTIONS]</span>

    <span class="s1">timeout: </span><span class="s0">None </span><span class="s1">| (float)</span>

    <span class="s1">host: str</span>
    <span class="s1">port: int</span>
    <span class="s1">blocksize: int</span>
    <span class="s1">source_address: tuple[str</span><span class="s0">, </span><span class="s1">int] | </span><span class="s0">None</span>
    <span class="s1">socket_options: _TYPE_SOCKET_OPTIONS | </span><span class="s0">None</span>

    <span class="s1">proxy: Url | </span><span class="s0">None</span>
    <span class="s1">proxy_config: ProxyConfig | </span><span class="s0">None</span>

    <span class="s1">is_verified: bool = </span><span class="s0">False</span>
    <span class="s1">proxy_is_verified: bool | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None</span>

    <span class="s1">_response: EmscriptenResponse | </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">__init__(</span>
        <span class="s1">self</span><span class="s0">,</span>
        <span class="s1">host: str</span><span class="s0">,</span>
        <span class="s1">port: int = </span><span class="s4">0</span><span class="s0">,</span>
        <span class="s1">*</span><span class="s0">,</span>
        <span class="s1">timeout: _TYPE_TIMEOUT = _DEFAULT_TIMEOUT</span><span class="s0">,</span>
        <span class="s1">source_address: tuple[str</span><span class="s0">, </span><span class="s1">int] | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">blocksize: int = </span><span class="s4">8192</span><span class="s0">,</span>
        <span class="s1">socket_options: _TYPE_SOCKET_OPTIONS | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">proxy: Url | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">proxy_config: ProxyConfig | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
    <span class="s1">) -&gt; </span><span class="s0">None</span><span class="s1">:</span>
        <span class="s1">self.host = host</span>
        <span class="s1">self.port = port</span>
        <span class="s1">self.timeout = timeout </span><span class="s0">if </span><span class="s1">isinstance(timeout</span><span class="s0">, </span><span class="s1">float) </span><span class="s0">else </span><span class="s4">0.0</span>
        <span class="s1">self.scheme = </span><span class="s3">&quot;http&quot;</span>
        <span class="s1">self._closed = </span><span class="s0">True</span>
        <span class="s1">self._response = </span><span class="s0">None</span>
        <span class="s2"># ignore these things because we don't</span>
        <span class="s2"># have control over that stuff</span>
        <span class="s1">self.proxy = </span><span class="s0">None</span>
        <span class="s1">self.proxy_config = </span><span class="s0">None</span>
        <span class="s1">self.blocksize = blocksize</span>
        <span class="s1">self.source_address = </span><span class="s0">None</span>
        <span class="s1">self.socket_options = </span><span class="s0">None</span>
        <span class="s1">self.is_verified = </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">set_tunnel(</span>
        <span class="s1">self</span><span class="s0">,</span>
        <span class="s1">host: str</span><span class="s0">,</span>
        <span class="s1">port: int | </span><span class="s0">None </span><span class="s1">= </span><span class="s4">0</span><span class="s0">,</span>
        <span class="s1">headers: typing.Mapping[str</span><span class="s0">, </span><span class="s1">str] | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">scheme: str = </span><span class="s3">&quot;http&quot;</span><span class="s0">,</span>
    <span class="s1">) -&gt; </span><span class="s0">None</span><span class="s1">:</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">connect(self) -&gt; </span><span class="s0">None</span><span class="s1">:</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">request(</span>
        <span class="s1">self</span><span class="s0">,</span>
        <span class="s1">method: str</span><span class="s0">,</span>
        <span class="s1">url: str</span><span class="s0">,</span>
        <span class="s1">body: _TYPE_BODY | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">headers: typing.Mapping[str</span><span class="s0">, </span><span class="s1">str] | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s2"># We know *at least* botocore is depending on the order of the</span>
        <span class="s2"># first 3 parameters so to be safe we only mark the later ones</span>
        <span class="s2"># as keyword-only to ensure we have space to extend.</span>
        <span class="s1">*</span><span class="s0">,</span>
        <span class="s1">chunked: bool = </span><span class="s0">False,</span>
        <span class="s1">preload_content: bool = </span><span class="s0">True,</span>
        <span class="s1">decode_content: bool = </span><span class="s0">True,</span>
        <span class="s1">enforce_content_length: bool = </span><span class="s0">True,</span>
    <span class="s1">) -&gt; </span><span class="s0">None</span><span class="s1">:</span>
        <span class="s1">self._closed = </span><span class="s0">False</span>
        <span class="s0">if </span><span class="s1">url.startswith(</span><span class="s3">&quot;/&quot;</span><span class="s1">):</span>
            <span class="s2"># no scheme / host / port included, make a full url</span>
            <span class="s1">url = </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">self.scheme</span><span class="s0">}</span><span class="s3">://</span><span class="s0">{</span><span class="s1">self.host</span><span class="s0">}</span><span class="s3">:</span><span class="s0">{</span><span class="s1">self.port</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s1">+ url</span>
        <span class="s1">request = EmscriptenRequest(</span>
            <span class="s1">url=url</span><span class="s0">,</span>
            <span class="s1">method=method</span><span class="s0">,</span>
            <span class="s1">timeout=self.timeout </span><span class="s0">if </span><span class="s1">self.timeout </span><span class="s0">else </span><span class="s4">0</span><span class="s0">,</span>
            <span class="s1">decode_content=decode_content</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">request.set_body(body)</span>
        <span class="s0">if </span><span class="s1">headers:</span>
            <span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">headers.items():</span>
                <span class="s1">request.set_header(k</span><span class="s0">, </span><span class="s1">v)</span>
        <span class="s1">self._response = </span><span class="s0">None</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s0">if not </span><span class="s1">preload_content:</span>
                <span class="s1">self._response = send_streaming_request(request)</span>
            <span class="s0">if </span><span class="s1">self._response </span><span class="s0">is None</span><span class="s1">:</span>
                <span class="s1">self._response = send_request(request)</span>
        <span class="s0">except </span><span class="s1">_TimeoutError </span><span class="s0">as </span><span class="s1">e:</span>
            <span class="s0">raise </span><span class="s1">TimeoutError(e.message) </span><span class="s0">from </span><span class="s1">e</span>
        <span class="s0">except </span><span class="s1">_RequestError </span><span class="s0">as </span><span class="s1">e:</span>
            <span class="s0">raise </span><span class="s1">HTTPException(e.message) </span><span class="s0">from </span><span class="s1">e</span>

    <span class="s0">def </span><span class="s1">getresponse(self) -&gt; BaseHTTPResponse:</span>
        <span class="s0">if </span><span class="s1">self._response </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s0">return </span><span class="s1">EmscriptenHttpResponseWrapper(</span>
                <span class="s1">internal_response=self._response</span><span class="s0">,</span>
                <span class="s1">url=self._response.request.url</span><span class="s0">,</span>
                <span class="s1">connection=self</span><span class="s0">,</span>
            <span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">ResponseNotReady()</span>

    <span class="s0">def </span><span class="s1">close(self) -&gt; </span><span class="s0">None</span><span class="s1">:</span>
        <span class="s1">self._closed = </span><span class="s0">True</span>
        <span class="s1">self._response = </span><span class="s0">None</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">is_closed(self) -&gt; bool:</span>
        <span class="s5">&quot;&quot;&quot;Whether the connection either is brand new or has been previously closed. 
        If this property is True then both ``is_connected`` and ``has_connected_to_proxy`` 
        properties must be False. 
        &quot;&quot;&quot;</span>
        <span class="s0">return </span><span class="s1">self._closed</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">is_connected(self) -&gt; bool:</span>
        <span class="s5">&quot;&quot;&quot;Whether the connection is actively connected to any origin (proxy or target)&quot;&quot;&quot;</span>
        <span class="s0">return True</span>

    <span class="s1">@property</span>
    <span class="s0">def </span><span class="s1">has_connected_to_proxy(self) -&gt; bool:</span>
        <span class="s5">&quot;&quot;&quot;Whether the connection has successfully connected to its proxy. 
        This returns False if no proxy is in use. Used to determine whether 
        errors are coming from the proxy layer or from tunnelling to the target origin. 
        &quot;&quot;&quot;</span>
        <span class="s0">return False</span>


<span class="s0">class </span><span class="s1">EmscriptenHTTPSConnection(EmscriptenHTTPConnection):</span>
    <span class="s1">default_port = port_by_scheme[</span><span class="s3">&quot;https&quot;</span><span class="s1">]</span>
    <span class="s2"># all this is basically ignored, as browser handles https</span>
    <span class="s1">cert_reqs: int | str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None</span>
    <span class="s1">ca_certs: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None</span>
    <span class="s1">ca_cert_dir: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None</span>
    <span class="s1">ca_cert_data: </span><span class="s0">None </span><span class="s1">| str | bytes = </span><span class="s0">None</span>
    <span class="s1">cert_file: str | </span><span class="s0">None</span>
    <span class="s1">key_file: str | </span><span class="s0">None</span>
    <span class="s1">key_password: str | </span><span class="s0">None</span>
    <span class="s1">ssl_context: typing.Any | </span><span class="s0">None</span>
    <span class="s1">ssl_version: int | str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None</span>
    <span class="s1">ssl_minimum_version: int | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None</span>
    <span class="s1">ssl_maximum_version: int | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None</span>
    <span class="s1">assert_hostname: </span><span class="s0">None </span><span class="s1">| str | typing.Literal[</span><span class="s0">False</span><span class="s1">]</span>
    <span class="s1">assert_fingerprint: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">__init__(</span>
        <span class="s1">self</span><span class="s0">,</span>
        <span class="s1">host: str</span><span class="s0">,</span>
        <span class="s1">port: int = </span><span class="s4">0</span><span class="s0">,</span>
        <span class="s1">*</span><span class="s0">,</span>
        <span class="s1">timeout: _TYPE_TIMEOUT = _DEFAULT_TIMEOUT</span><span class="s0">,</span>
        <span class="s1">source_address: tuple[str</span><span class="s0">, </span><span class="s1">int] | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">blocksize: int = </span><span class="s4">16384</span><span class="s0">,</span>
        <span class="s1">socket_options: </span><span class="s0">None</span>
        <span class="s1">| _TYPE_SOCKET_OPTIONS = HTTPConnection.default_socket_options</span><span class="s0">,</span>
        <span class="s1">proxy: Url | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">proxy_config: ProxyConfig | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">cert_reqs: int | str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">assert_hostname: </span><span class="s0">None </span><span class="s1">| str | typing.Literal[</span><span class="s0">False</span><span class="s1">] = </span><span class="s0">None,</span>
        <span class="s1">assert_fingerprint: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">server_hostname: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">ssl_context: typing.Any | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">ca_certs: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">ca_cert_dir: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">ca_cert_data: </span><span class="s0">None </span><span class="s1">| str | bytes = </span><span class="s0">None,</span>
        <span class="s1">ssl_minimum_version: int | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">ssl_maximum_version: int | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">ssl_version: int | str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,  </span><span class="s2"># Deprecated</span>
        <span class="s1">cert_file: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">key_file: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">key_password: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
    <span class="s1">) -&gt; </span><span class="s0">None</span><span class="s1">:</span>
        <span class="s1">super().__init__(</span>
            <span class="s1">host</span><span class="s0">,</span>
            <span class="s1">port=port</span><span class="s0">,</span>
            <span class="s1">timeout=timeout</span><span class="s0">,</span>
            <span class="s1">source_address=source_address</span><span class="s0">,</span>
            <span class="s1">blocksize=blocksize</span><span class="s0">,</span>
            <span class="s1">socket_options=socket_options</span><span class="s0">,</span>
            <span class="s1">proxy=proxy</span><span class="s0">,</span>
            <span class="s1">proxy_config=proxy_config</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">self.scheme = </span><span class="s3">&quot;https&quot;</span>

        <span class="s1">self.key_file = key_file</span>
        <span class="s1">self.cert_file = cert_file</span>
        <span class="s1">self.key_password = key_password</span>
        <span class="s1">self.ssl_context = ssl_context</span>
        <span class="s1">self.server_hostname = server_hostname</span>
        <span class="s1">self.assert_hostname = assert_hostname</span>
        <span class="s1">self.assert_fingerprint = assert_fingerprint</span>
        <span class="s1">self.ssl_version = ssl_version</span>
        <span class="s1">self.ssl_minimum_version = ssl_minimum_version</span>
        <span class="s1">self.ssl_maximum_version = ssl_maximum_version</span>
        <span class="s1">self.ca_certs = ca_certs </span><span class="s0">and </span><span class="s1">os.path.expanduser(ca_certs)</span>
        <span class="s1">self.ca_cert_dir = ca_cert_dir </span><span class="s0">and </span><span class="s1">os.path.expanduser(ca_cert_dir)</span>
        <span class="s1">self.ca_cert_data = ca_cert_data</span>

        <span class="s1">self.cert_reqs = </span><span class="s0">None</span>

        <span class="s2"># The browser will automatically verify all requests.</span>
        <span class="s2"># We have no control over that setting.</span>
        <span class="s1">self.is_verified = </span><span class="s0">True</span>

    <span class="s0">def </span><span class="s1">set_cert(</span>
        <span class="s1">self</span><span class="s0">,</span>
        <span class="s1">key_file: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">cert_file: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">cert_reqs: int | str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">key_password: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">ca_certs: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">assert_hostname: </span><span class="s0">None </span><span class="s1">| str | typing.Literal[</span><span class="s0">False</span><span class="s1">] = </span><span class="s0">None,</span>
        <span class="s1">assert_fingerprint: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">ca_cert_dir: str | </span><span class="s0">None </span><span class="s1">= </span><span class="s0">None,</span>
        <span class="s1">ca_cert_data: </span><span class="s0">None </span><span class="s1">| str | bytes = </span><span class="s0">None,</span>
    <span class="s1">) -&gt; </span><span class="s0">None</span><span class="s1">:</span>
        <span class="s0">pass</span>


<span class="s2"># verify that this class implements BaseHTTP(s) connection correctly</span>
<span class="s0">if </span><span class="s1">typing.TYPE_CHECKING:</span>
    <span class="s1">_supports_http_protocol: BaseHTTPConnection = EmscriptenHTTPConnection(</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">_supports_https_protocol: BaseHTTPSConnection = EmscriptenHTTPSConnection(</span><span class="s3">&quot;&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
</pre>
</body>
</html>